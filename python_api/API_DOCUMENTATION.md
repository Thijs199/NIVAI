# Python Football Analysis API Documentation

## 1. Introduction

This document provides documentation for the Python API responsible for calculating and serving football match physical statistics. The API processes raw tracking and event data to generate insights into player and team performance.

**Base URL:**

*   Default: `http://localhost:8081`
*   This URL is configurable via environment variables for the Go backend service that calls this Python API.

## 2. General Notes

*   **Authentication:** Currently, this API is designed for internal use (called by the Go backend) and does not implement its own authentication layer. Access control is assumed to be handled by the calling service.
*   **Data Formats:** All request and response bodies are in JSON format (`application/json`).
*   **Error Handling:**
    *   `400 Bad Request`: Typically used when required file paths are invalid or missing in the `/process-match` request.
    *   `404 Not Found`: Used when a requested resource (e.g., a specific `match_id`, `player_id`, or `team_id`) is not found, or if a match has not been processed yet.
    *   `422 Unprocessable Entity`: Used if the request body for `POST` requests is malformed or missing required fields (FastAPI default).
    *   `500 Internal Server Error`: Indicates an unexpected error occurred on the server while processing the request.

## 3. Endpoint Documentation

### 3.1. Process Match Data

Initiates background processing of tracking and event data for a given match. The actual data processing happens asynchronously.

*   **Method:** `POST`
*   **URL:** `/process-match`
*   **Request Body (JSON):**
    ```json
    {
      "tracking_data_path": "string (absolute path to the tracking data file, e.g., .parquet or .gzip)",
      "event_data_path": "string (absolute path to the event data file, e.g., .parquet or .gzip)",
      "match_id": "string (a unique identifier for the match, e.g., UUID)"
    }
    ```
*   **Success Response (`202 Accepted`):**
    Indicates that the request has been accepted and processing has started in the background.
    ```json
    {
      "message": "Match processing started in background.",
      "match_id": "string (the match_id provided or generated by the Go backend, passed through here)"
    }
    ```
*   **Error Responses:**
    *   `404 Not Found`: If `tracking_data_path` or `event_data_path` specified in the request do not exist on the server where the Python API runs.
    *   `422 Unprocessable Entity`: If the request JSON body is malformed or missing required fields like `tracking_data_path` or `event_data_path`.
    *   `500 Internal Server Error`: For other unexpected errors during the initiation of processing.

### 3.2. Get Match Processing Status

Checks the processing status of a specific match.

*   **Method:** `GET`
*   **URL:** `/match/{match_id}/status`
*   **URL Parameters:**
    *   `match_id` (string, required): The unique ID of the match.
*   **Success Response (`200 OK`):**
    ```json
    {
      "status": "string (e.g., 'pending', 'processed', 'error')",
      "match_id": "string (the match_id)",
      "message": "string (optional, present if status is 'error' or for additional info)"
    }
    ```
    Example `status` values:
    *   `pending`: Processing has been initiated but is not yet complete.
    *   `processed`: Processing completed successfully. Data is available.
    *   `error`: An error occurred during processing. The `message` field will contain more details.
*   **Error Responses:**
    *   `404 Not Found`: If the `match_id` does not exist in the cache (i.e., processing was never initiated or the ID is invalid).

### 3.3. Get Match Statistics Summary

Retrieves aggregated player and team statistics for a fully processed match.

*   **Method:** `GET`
*   **URL:** `/match/{match_id}/stats/summary`
*   **URL Parameters:**
    *   `match_id` (string, required): The ID of the match.
*   **Success Response (`200 OK`):**
    The response contains two main objects: `players` and `teams`, where each is a dictionary keyed by player ID and team ID respectively.
    ```json
    {
      "match_id": "string (the ID of the match)",
      "players": {
        "player_id_1": {
          // PlayerSummary object (see Data Models section)
          "player_id": "player_id_1",
          "team_id": "team_id_A",
          "player_name": "Player One (or player_id_1 if name not available)",
          "total_distance_m": 10500.75,
          "total_sprint_distance_m": 850.2,
          // ... other PlayerSummary fields
        },
        "player_id_2": { /* PlayerSummary object */ }
      },
      "teams": {
        "team_id_A": {
          // TeamSummaryStats object (see Data Models section)
          // These are typically aggregations of the player stats for that team.
          "team_id": "team_id_A",
          "team_name": "Team Alpha (if available)",
          "total_distance_m": 55200.0,
          // ... other TeamSummaryStats fields
        },
        "team_id_B": { /* TeamSummaryStats object */ }
      }
    }
    ```
*   **Error Responses:**
    *   `404 Not Found`: If `match_id` is not found, or if its status is not "processed".

### 3.4. Get Player Details (Time Series)

Retrieves detailed time-series data for a specific player within a processed match.

*   **Method:** `GET`
*   **URL:** `/match/{match_id}/player/{player_id}/details`
*   **URL Parameters:**
    *   `match_id` (string, required): The ID of the match.
    *   `player_id` (string, required): The ID of the player.
*   **Success Response (`200 OK`):**
    A JSON object containing a `time_series` key, which holds a list of data points, one for each recorded frame/timestamp for the player.
    ```json
    {
      "match_id": "string (the ID of the match)",
      "player_id": "string (the ID of the player)",
      "time_series": [
        {
          // PlayerTimeSeriesDataPoint object (see Data Models section)
          "timestamp_ms": 1600000000,
          "time_s": 1600000.000, // Timestamp in seconds
          "x": 10.5,
          "y": -5.2,
          "speed_kmh": 10.5,
          "distance_covered_m": 0.25,
          "is_sprinting": false,
          "is_high_intensity_running": true,
          "acceleration_ms2": 0.1
        },
        { /* ... more data points ... */ }
      ]
    }
    ```
*   **Error Responses:**
    *   `404 Not Found`: If `match_id` is not found, its status is not "processed", or the specified `player_id` is not found within that match's data.

### 3.5. Get Team Summary Over Time (Intervals)

Retrieves aggregated team metrics (e.g., total distance, average speed) over time intervals (typically 5 minutes) for a specific team within a processed match.

*   **Method:** `GET`
*   **URL:** `/match/{match_id}/team/{team_id}/summary-over-time`
*   **URL Parameters:**
    *   `match_id` (string, required): The ID of the match.
    *   `team_id` (string, required): The ID of the team.
*   **Success Response (`200 OK`):**
    A JSON object containing an `intervals` key, which holds a list of data points, one for each time interval.
    ```json
    {
      "match_id": "string (the ID of the match)",
      "team_id": "string (the ID of the team)",
      "intervals": [
        {
          // TeamIntervalDataPoint object (see Data Models section)
          "interval_start_time_s": 0.0,
          "interval_end_time_s": 300.0,
          // "interval_readable_label": "0-5 min", // May be added by frontend
          "total_distance_m": 5200.5,
          "total_high_intensity_running_distance_m": 1200.0,
          "total_sprint_distance_m": 300.0,
          "total_num_accelerations": 50,
          "total_num_decelerations": 45,
          "avg_team_speed_kmh": 7.8
        },
        { /* ... more interval data points ... */ }
      ]
    }
    ```
*   **Error Responses:**
    *   `404 Not Found`: If `match_id` is not found, its status is not "processed", or the specified `team_id` is not found within that match's data.

## 4. Data Models / DTOs

These are brief descriptions of the main data objects returned by the API.

*   **PlayerSummary:** Represents aggregated statistics for a single player over the entire match.
    *   `player_id`: string - Unique identifier for the player.
    *   `team_id`: string - Identifier for the player's team.
    *   `player_name`: string (optional) - Name of the player (might be same as `player_id` if not available).
    *   `total_distance_m`: number - Total distance covered in meters.
    *   `avg_speed_kmh`: number - Average speed in km/h.
    *   `max_speed_kmh`: number - Maximum speed achieved in km/h.
    *   `total_high_intensity_running_distance_m`: number - Distance covered during high-intensity running.
    *   `total_sprint_distance_m`: number - Distance covered while sprinting.
    *   `num_accelerations`: integer - Count of significant accelerations.
    *   `num_decelerations`: integer - Count of significant decelerations.
    *   `duration_minutes`: number - Duration the player was tracked in minutes.

*   **TeamSummaryStats:** Represents aggregated statistics for a single team over the entire match.
    *   `team_id`: string - Unique identifier for the team.
    *   `team_name`: string (optional) - Name of the team (might be same as `team_id` if not available).
    *   `total_distance_m`: number - Sum of total distances of all players in the team.
    *   `avg_speed_kmh`: number - Average of average speeds of players in the team (or overall team average).
    *   `max_speed_kmh`: number - Maximum speed achieved by any player in the team.
    *   `total_high_intensity_running_distance_m`: number - Sum for the team.
    *   `total_sprint_distance_m`: number - Sum for the team.
    *   `total_num_accelerations`: integer - Sum for the team.
    *   `total_num_decelerations`: integer - Sum for the team.
    *   `duration_minutes`: number - Total player-minutes for the team or match duration.


*   **PlayerTimeSeriesDataPoint:** Represents player's state at a specific timestamp.
    *   `timestamp_ms`: integer - Original timestamp in milliseconds.
    *   `time_s`: number - Timestamp in seconds (derived from `timestamp_ms`).
    *   `x`: number (optional) - X coordinate.
    *   `y`: number (optional) - Y coordinate.
    *   `speed_kmh`: number - Instantaneous speed in km/h.
    *   `distance_covered_m`: number - Distance covered in the segment leading to this point.
    *   `is_sprinting`: boolean - True if speed is above sprint threshold.
    *   `is_high_intensity_running`: boolean - True if speed is in high-intensity running band.
    *   `acceleration_ms2`: number - Instantaneous acceleration in m/s².

*   **TeamIntervalDataPoint:** Represents aggregated team statistics for a specific time interval.
    *   `interval_start_time_s`: number - Start time of the interval in seconds from match start.
    *   `interval_end_time_s`: number - End time of the interval in seconds from match start.
    *   `total_distance_m`: number - Total distance covered by the team in this interval.
    *   `avg_team_speed_kmh`: number - Average speed of the team in this interval.
    *   `total_high_intensity_running_distance_m`: number - Team HIR distance in interval.
    *   `total_sprint_distance_m`: number - Team sprint distance in interval.
    *   `total_num_accelerations`: integer - Team accelerations in interval.
    *   `total_num_decelerations`: integer - Team decelerations in interval.

## 5. Future Considerations
*   More detailed error codes and messages.
*   Pagination for time-series data if it can be very large.
*   Additional endpoints for more specific queries (e.g., top N players by a certain metric).
